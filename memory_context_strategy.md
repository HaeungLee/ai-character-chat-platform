# Memory & Context Strategy (v1)

목표: 긴 대화에서 캐릭터가 초기 설정으로 “리셋”되지 않도록, **고정 페르소나(변하지 않는 설정)** 와 **가변 상태(대화로 변화하는 현재 상태)** 를 분리해 저비용으로 유지한다.

---

## 1) 핵심 원칙

- **고정 페르소나(Immutable Persona)**: 캐릭터 카드/시스템 프롬프트/로어북의 “설정”에 해당. 기본 성격·말투·세계관·금기/경계·기본 관계(초기값).
- **가변 상태(Mutable State)**: 대화가 진행되며 변하는 “현재의 사실”. 관계 변화, 진행 중인 목표, 최근 사건의 결과, 합의/약속, 현재 감정의 흐름 등.
- **주입 우선순위**: 
  - 페르소나 = “항상 유지해야 하는 규칙”
  - 상태 = “현재 시점의 정합성(캐논)”
  - 기억(RAG) = “참고 자료(근거/회상)”

---

## 2) 저장소 역할 (현재 코드 기준)

- PostgreSQL (Prisma)
  - `character_memory_configs`: 캐릭터별 메모리 설정/카운트
  - `semantic_memories`: 구조화된 사실(키/값) 저장
  - `episodic_memories`: 대화 요약(일화) 저장
  - `emotional_memories`: 감정적으로 중요한 순간 저장
  - `summarization_jobs`: 요약 작업 큐
- MongoDB
  - 원본 대화 메시지 로그(`chat_messages`)
  - 요약/아카이브 기록(`memory_summary_archives` 등)
- Redis
  - (설계상) Working Memory 캐시 용도. 현재 MVP는 필수 아님.

---

## 3) “현재 상태” 정의 (v1)

### 3.1 상태로 취급할 SemanticCategory

아래 카테고리는 **가변 상태**로 간주하고 시스템 프롬프트에 별도 블록으로 주입한다.

- `RELATIONSHIP` (관계 상태)
- `GOAL` (진행 중 목표/계획)
- `EVENT` (최근 사건/변화)
- `HABIT` (최근에 바뀐 습관/패턴)
- `OPINION` (최근에 형성/변경된 생각)

아래 카테고리는 “기본 정보”에 가깝기 때문에 상태 블록이 아닌 일반 기억/사실로 취급한다.

- `PERSONAL_INFO`
- `PREFERENCE`
- `OTHER`

### 3.2 상태 블록 포맷

시스템 프롬프트에 아래 형태로 주입한다(사용자에게 직접 언급 금지).

```
[현재 상태(캐논)]
- (category) key: value
- ...
```

지시문은 다음을 포함한다.

- 위 항목들은 **현재 시점의 정합성**으로 취급한다.
- 사용자 메시지가 새로운 사실을 제공하거나 모순되면, 자연스럽게 **상태가 업데이트되는 방향**으로 응답한다.
- 상태/기억 블록의 존재를 “메타”로 언급하지 않는다.

---

## 4) 검색/주입 규칙 (v1)

### 4.1 State Injection (비용 고정)

- `semantic_memories`에서 중요도 높은 항목을 가져와 상태 블록을 구성한다.
- 상한: 약 `~500 tokens` 수준(대략 `1500 chars` 내에서 컷)으로 제한한다.
- RAG 유사도 검색과 무관하게 **항상 주입**(또는 옵션으로 on/off).

### 4.2 RAG Injection (비용 가변)

- `EmbeddingService.searchSimilarMemories()`로 유사도 기반 Top-K를 가져오고, 부족하면 최근/중요 메모리로 보완.
- 프롬프트에는 “기억을 직접 언급하지 말라”는 룰을 유지.

---

## 5) 업데이트(추출) 규칙 (v1)

현재 구현은 `SummarizationService.extractImportantInfo()`를 통해 **사용자 메시지 기반**으로 semantic memory를 실시간 생성한다.

- 장점: 비용이 낮고 구현이 단순
- 한계: ‘치유됨/관계 진전’처럼 **대화의 결론이 assistant 쪽에서 발생**하는 경우를 놓칠 수 있음

v2 제안(후순위):
- user+assistant 한 턴을 묶어 요약/추출하거나, 특정 패턴(“약속/합의/관계 정의”)에 한해 assistant도 추출 대상으로 포함.

---

## 6) Acceptance Criteria

- 긴 대화에서도 관계/사건 진행이 유지되고, 모델이 초기 설정으로 되돌아가지 않는다.
- 상태 블록이 과도하게 길어지지 않는다(상한 준수).
- 상태/기억 블록을 사용자에게 직접 언급하지 않는다.
