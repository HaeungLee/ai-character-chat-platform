// AI 캐릭터 채팅 플랫폼 데이터베이스 스키마
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 사용자 모델
model User {
  id          String   @id @default(cuid())
  email       String   @unique
  username    String?  @unique
  password    String
  avatar      String?
  bio         String?
  role        UserRole @default(USER)
  status      UserStatus @default(ACTIVE)

  // 소셜 로그인 정보
  googleId    String?  @unique
  githubId    String?  @unique

  // 구독 정보
  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  // 채팅 관련
  chats       Chat[]

  // 결제 기록
  payments    Payment[]

  // 이미지 생성 기록
  imageGenerations ImageGeneration[]

  // AI 사용량 로그
  aiUsageLogs AIUsageLog[]

  // 타임스탬프
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLoginAt DateTime?

  @@map("users")
}

// AI 캐릭터 모델
model Character {
  id          String   @id @default(cuid())
  name        String
  avatar      String?
  description String?
  personality String?  // 캐릭터 성격 설명
  systemPrompt String  // AI 시스템 프롬프트

  // 캐릭터 설정
  voice       String?  // 음성 설정
  appearance  String?  // 외모 설명
  background  String?  // 캐릭터 배경

  // 카테고리 및 태그
  category    String?
  tags        String[]

  // 사용 통계
  usageCount  Int      @default(0)
  rating      Float?   @default(0)
  reviewCount Int      @default(0)

  // 채팅 세션
  chats       Chat[]
  
  // 관계 및 확장 기능
  lorebookEntries LorebookEntry[] // 세계관/설정집
  exampleDialogues String?        // Few-shot 예제 대화

  // 타임스탬프
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isActive    Boolean  @default(true)

  @@map("characters")
}


// 캐릭터 세계관/설정집 (Lorebook)
model LorebookEntry {
  id          String   @id @default(cuid())
  
  // 관계
  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  // 내용
  keys        String[] // 발동 키워드 (예: "마법학교", "교장선생님")
  content     String   // 주입될 설정 내용
  priority    Int      @default(10) // 삽입 우선순위
  
  // 상태
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([characterId])
  @@map("lorebook_entries")
}

// 채팅 세션 모델
model Chat {
  id          String   @id @default(cuid())
  title       String?

  // 관계
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  // 채팅 설정
  model       String   @default("gpt-4") // 사용된 AI 모델
  temperature Float?   @default(0.7)
  maxTokens   Int?     @default(1000)

  // 메시지
  messages    Message[]

  // 통계
  messageCount Int     @default(0)
  totalTokens  Int     @default(0)

  // 타임스탬프
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastActivity DateTime @default(now())

  @@map("chats")
}

// 메시지 모델
model Message {
  id          String   @id @default(cuid())

  // 관계
  chatId      String
  chat        Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)

  // 메시지 내용
  role        MessageRole // user, assistant
  content     String
  tokens      Int?     // 토큰 수

  // 메타데이터
  metadata    Json?    // 추가 메타데이터 (이미지 URL 등)

  // 타임스탬프
  createdAt   DateTime @default(now())

  @@map("messages")
}

// 이미지 생성 기록 모델
model ImageGeneration {
  id          String   @id @default(cuid())

  // 사용자 정보
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 생성 정보
  prompt      String
  negativePrompt String?
  model       String   @default("dall-e-3")
  style       String?
  size        String   @default("1024x1024")

  // 결과
  imageUrl    String
  status      GenerationStatus @default(PENDING)

  // 비용 계산
  cost        Float?   // 생성 비용 (크레딧)
  tokens      Int?     // 사용된 토큰 수

  // 타임스탬프
  createdAt   DateTime @default(now())
  completedAt DateTime?

  @@map("image_generations")
}

// 구독 플랜 모델
model Subscription {
  id          String   @id @default(cuid())
  name        String
  description String?

  // 가격 및 기간
  price       Float
  currency    String   @default("USD")
  interval    SubscriptionInterval // monthly, yearly
  credits     Int      // 월별 크레딧 수

  // 기능 제한
  maxChats    Int?     // 최대 채팅 수
  maxImages   Int?     // 최대 이미지 생성 수
  priority    Boolean  @default(false) // 우선 처리

  // 사용자
  users       User[]

  // 결제 기록
  payments    Payment[]

  // 타임스탬프
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isActive    Boolean  @default(true)

  @@map("subscriptions")
}

// 결제 기록 모델
model Payment {
  id          String   @id @default(cuid())

  // 사용자 정보
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 결제 정보
  amount      Float
  currency    String   @default("USD")
  status      PaymentStatus @default(PENDING)

  // Stripe 정보
  stripePaymentIntentId String? @unique
  stripeCustomerId      String?

  // 구독 정보
  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  // 메타데이터
  metadata    Json?

  // 타임스탬프
  createdAt   DateTime @default(now())
  completedAt DateTime?

  @@map("payments")
}

// 열거형 정의
enum UserRole {
  USER
  ADMIN
  PREMIUM
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
  SUSPENDED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum GenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum SubscriptionInterval {
  MONTHLY
  YEARLY
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

// =====================================================
// 장기 기억 시스템 (Vector DB + RAG)
// =====================================================

// 캐릭터별 메모리 설정
model CharacterMemoryConfig {
  id          String   @id @default(cuid())
  
  // 관계
  userId      String
  characterId String
  
  // 메모리 설정
  maxMemories      Int     @default(30)  // 기본 30개 메모리 제한
  totalMemories    Int     @default(0)   // 현재 저장된 메모리 수
  summarizedTokens Int     @default(0)   // 요약에 사용된 토큰 수
  
  // 컨텍스트 관리
  lastContextCheck DateTime?  // 마지막 컨텍스트 체크 시간
  contextUsagePercent Float @default(0)  // 현재 컨텍스트 사용률
  
  // 타임스탬프
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastAccessAt DateTime @default(now())  // 비활성 계정 체크용
  
  // 에피소드 메모리 관계
  episodicMemories EpisodicMemory[]
  semanticMemories SemanticMemory[]
  emotionalMemories EmotionalMemory[]
  
  @@unique([userId, characterId])
  @@index([userId])
  @@index([characterId])
  @@index([lastAccessAt])
  @@map("character_memory_configs")
}

// 에피소드 기억 (대화 요약)
model EpisodicMemory {
  id          String   @id @default(cuid())
  
  // 관계
  configId    String
  config      CharacterMemoryConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  
  // 메모리 내용
  summary     String   // 요약된 대화 내용
  context     String?  // 추가 컨텍스트
  
  // 원본 참조 (MongoDB ObjectId)
  originalMessageIds String[]  // 원본 메시지 ID들
  messageRange   Json?   // { startMessageId, endMessageId, startTime, endTime }
  
  // 메타데이터
  importance  Float    @default(0.5)  // 0.0 ~ 1.0 중요도
  accessCount Int      @default(0)    // 접근 횟수
  lastAccessed DateTime @default(now())
  
  // 벡터 임베딩 (pgvector) - Raw SQL로 처리
  // embedding vector(1536) - OpenAI ada-002 기준
  embeddingId String?  // MemoryEmbedding 참조
  
  // 사용자 편집
  isEdited    Boolean  @default(false)
  editedAt    DateTime?
  originalSummary String?  // 편집 전 원본
  
  // 타임스탬프
  createdAt   DateTime @default(now())
  expiresAt   DateTime?  // 만료 시간 (중요도 기반)
  
  @@index([configId])
  @@index([importance])
  @@index([lastAccessed])
  @@index([expiresAt])
  @@map("episodic_memories")
}

// 의미적 기억 (사실, 관계, 선호도)
model SemanticMemory {
  id          String   @id @default(cuid())
  
  // 관계
  configId    String
  config      CharacterMemoryConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  
  // 메모리 분류
  category    SemanticCategory
  
  // 내용
  key         String   // 예: "생일", "좋아하는 음식"
  value       String   // 예: "3월 15일", "파스타"
  context     String?  // 추가 컨텍스트
  
  // 확신도
  confidence  Float    @default(0.8)  // 0.0 ~ 1.0
  
  // 메타데이터
  sourceMessageId String?  // 원본 메시지 ID
  importance  Float    @default(0.7)
  accessCount Int      @default(0)
  lastAccessed DateTime @default(now())
  
  // 벡터 임베딩
  embeddingId String?
  
  // 사용자 편집
  isEdited    Boolean  @default(false)
  editedAt    DateTime?
  
  // 타임스탬프
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([configId])
  @@index([category])
  @@index([key])
  @@index([importance])
  @@map("semantic_memories")
}

// 감정 기억
model EmotionalMemory {
  id          String   @id @default(cuid())
  
  // 관계
  configId    String
  config      CharacterMemoryConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  
  // 감정 정보
  emotion     String   // 예: "happy", "sad", "excited"
  intensity   Float    @default(0.5)  // 0.0 ~ 1.0 강도
  trigger     String   // 감정 유발 요인
  context     String?  // 상황 설명
  
  // 원본 참조
  sourceMessageId String?
  
  // 메타데이터
  importance  Float    @default(0.6)
  accessCount Int      @default(0)
  lastAccessed DateTime @default(now())
  
  // 벡터 임베딩
  embeddingId String?
  
  // 타임스탬프
  createdAt   DateTime @default(now())
  
  @@index([configId])
  @@index([emotion])
  @@index([importance])
  @@map("emotional_memories")
}

// 의미적 기억 카테고리
enum SemanticCategory {
  PERSONAL_INFO    // 개인 정보 (이름, 생일 등)
  PREFERENCE       // 선호도 (좋아하는 것, 싫어하는 것)
  RELATIONSHIP     // 관계 정보
  EVENT            // 중요 이벤트
  OPINION          // 의견/생각
  HABIT            // 습관
  GOAL             // 목표/계획
  OTHER            // 기타
}

// 요약 작업 큐
model SummarizationJob {
  id          String   @id @default(cuid())
  
  // 작업 대상
  userId      String
  characterId String
  chatId      String
  
  // 요약 범위
  startMessageId String
  endMessageId   String
  messageCount   Int
  
  // 작업 상태
  status      JobStatus @default(PENDING)
  priority    Int       @default(0)  // 높을수록 우선
  
  // 결과
  result      Json?     // 요약 결과
  error       String?   // 에러 메시지
  
  // 타임스탬프
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  
  @@index([status])
  @@index([priority])
  @@index([userId, characterId])
  @@map("summarization_jobs")
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// =====================================================
// AI 사용량 추적 시스템
// =====================================================

/// AI API 사용량 로그 (모든 Provider 통합)
model AIUsageLog {
  id                String   @id @default(cuid())
  
  // 사용자 정보
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Provider 정보
  provider          String   // 'openai' | 'openrouter' | 'replicate' | 'stability'
  model             String   // 'gpt-4o' | 'claude-3-sonnet' | 'gemini-pro' 등
  
  // 토큰 사용량
  promptTokens      Int      @default(0)
  completionTokens  Int      @default(0)
  totalTokens       Int      @default(0)
  
  // 비용 (USD, 소수점 6자리)
  costUsd           Decimal  @db.Decimal(10, 6)
  
  // 요청 정보
  requestType       String   // 'chat' | 'chat_stream' | 'image' | 'embedding' | 'summarization'
  characterId       String?
  chatId            String?
  
  // 성능 메트릭
  latencyMs         Int?     // 응답 시간 (밀리초)
  
  // 상태
  isSuccess         Boolean  @default(true)
  errorMessage      String?
  
  createdAt         DateTime @default(now())
  
  @@index([userId, createdAt])
  @@index([provider, createdAt])
  @@index([model, createdAt])
  @@index([requestType, createdAt])
  @@index([createdAt])
  @@map("ai_usage_logs")
}

/// Provider별 가격 설정 (관리자가 업데이트 가능)
model AIProviderPricing {
  id                  String   @id @default(cuid())
  
  provider            String   // 'openai' | 'openrouter' | 'anthropic' | 'google'
  model               String   // 모델 ID
  displayName         String?  // 표시 이름
  
  // 1K 토큰당 가격 (USD)
  inputPricePerK      Decimal  @db.Decimal(10, 6)
  outputPricePerK     Decimal  @db.Decimal(10, 6)
  
  // 이미지 생성 가격 (있는 경우)
  imagePricePerUnit   Decimal? @db.Decimal(10, 6)
  
  // 컨텍스트 정보
  contextWindow       Int?     // 최대 토큰 수
  
  // 상태
  isActive            Boolean  @default(true)
  isDefault           Boolean  @default(false) // 기본 모델 여부
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@unique([provider, model])
  @@index([provider, isActive])
  @@map("ai_provider_pricing")
}

/// 일일/월별 사용량 집계 (대시보드 성능 최적화)
model AIUsageSummary {
  id                String   @id @default(cuid())
  
  // 집계 기간
  periodType        String   // 'daily' | 'monthly'
  periodStart       DateTime // 기간 시작일 (일별: 00:00, 월별: 1일 00:00)
  
  // Provider별 집계 (NULL이면 전체)
  provider          String?
  
  // 집계 데이터
  totalRequests     Int      @default(0)
  successRequests   Int      @default(0)
  failedRequests    Int      @default(0)
  
  totalPromptTokens     Int      @default(0)
  totalCompletionTokens Int      @default(0)
  totalTokens           Int      @default(0)
  
  totalCostUsd      Decimal  @db.Decimal(12, 6) @default(0)
  
  // 사용자 통계
  uniqueUsers       Int      @default(0)
  
  // 평균 메트릭
  avgLatencyMs      Int?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([periodType, periodStart, provider])
  @@index([periodStart])
  @@index([periodType, periodStart])
  @@map("ai_usage_summaries")
}